<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-title style="padding-left: 16px;">
      <p-heading [size]="'large'" [theme]="'dark'">Settings</p-heading>
    </ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <div class="p-6 max-w-4xl mx-auto space-y-6">
    
    <!-- Notifications Section -->
    <div class="bg-[#2C2C2E] rounded-lg p-8 shadow-lg">
      <div class="flex items-center gap-3 mb-4">
        <p-icon [name]="'information'" [size]="'medium'" [theme]="'dark'"></p-icon>
        <p-heading [size]="'large'" [theme]="'dark'">Notifications</p-heading>
      </div>
      
      <div class="space-y-4">
        <div class="flex items-center justify-between py-2">
          <p-text [size]="'medium'" [theme]="'dark'">Enable Notifications</p-text>
          <p-switch 
            [checked]="notificationSettings.enabled" 
            (update)="toggleNotifications($event)"
            [theme]="'dark'">
          </p-switch>
        </div>

        <div *ngIf="notificationSettings.enabled" class="pt-2 border-t border-[#3A3A3C] space-y-4">
          <!-- Daily Earnings at 6 AM -->
          <div class="flex items-center justify-between py-2">
            <div>
              <p-text [size]="'medium'" [theme]="'dark'">Daily Earnings (6 AM)</p-text>
              <p-text [size]="'x-small'" [theme]="'dark'" class="block text-[#86868B]" style="padding: 4px 0;">
                Get earnings scheduled for today every morning
              </p-text>
            </div>
            <p-switch 
              [checked]="notificationSettings.dailyEarningsEnabled" 
              (update)="toggleDailyEarnings($event)"
              [theme]="'dark'">
            </p-switch>
          </div>

          <!-- Change Detection -->
          <div class="flex items-center justify-between py-2">
            <div>
              <p-text [size]="'medium'" [theme]="'dark'">Change Detection</p-text>
              <p-text [size]="'x-small'" [theme]="'dark'" class="block text-[#86868B]" style="padding: 4px 0;">
                Alert when earnings change in next 7 days
              </p-text>
            </div>
            <p-switch 
              [checked]="notificationSettings.changeDetectionEnabled" 
              (update)="toggleChangeDetection($event)"
              [theme]="'dark'">
            </p-switch>
          </div>

          <!-- Notification Time -->
          <div *ngIf="notificationSettings.dailyEarningsEnabled" class="pt-2 border-t border-[#3A3A3C]">
            <p-text [size]="'small'" [theme]="'dark'" class="block mb-2 text-[#C9C9CB]" style="padding: 4px 0;">Notification Time</p-text>
            <ion-input
              type="time"
              [value]="notificationSettings.notificationTime"
              (ionChange)="updateNotificationTime($event)"
              class="custom-input">
            </ion-input>
          </div>
        </div>

        <div *ngIf="notificationSettings.enabled" class="pt-2">
          <p-button 
            expand="full" 
            (click)="testNotification()" 
            [variant]="'secondary'"
            [theme]="'dark'">
            Test Notification
          </p-button>
        </div>
      </div>

      <p-text [size]="'x-small'" [theme]="'dark'" class="block mt-4 text-[#C9C9CB]" style="padding: 4px 0; line-height: 1.6;">
        <strong>ðŸ“± iOS Users:</strong> For push notifications to work on iPhone, you must add this app to your Home Screen first. Tap the Share button in Safari, then "Add to Home Screen".<br><br>
        <strong>ðŸ¤– Android Users:</strong> Notifications work directly in Chrome, Firefox, and Edge browsers. You can also install the app for a better experience.<br><br>
        <strong>ðŸ’» Desktop:</strong> Notifications work in all modern browsers.
      </p-text>
    </div>

    <!-- Watchlist Section -->
    <div class="bg-[#2C2C2E] rounded-lg p-8 shadow-lg">
      <div class="flex items-center gap-3 mb-4">
        <p-icon [name]="'menu-lines'" [size]="'medium'" [theme]="'dark'"></p-icon>
        <p-heading [size]="'large'" [theme]="'dark'">Stock Watchlist</p-heading>
      </div>

      <!-- Add Stock -->
      <div class="mb-4">
        <p-text [size]="'small'" [theme]="'dark'" class="block mb-2 text-[#C9C9CB]" style="padding: 4px 0;">Add Stock Symbol</p-text>
        <div class="flex gap-2">
          <ion-searchbar
            [(ngModel)]="newSymbol"
            placeholder="Enter stock symbol (e.g., AAPL)"
            (keyup.enter)="addStock()"
            [debounce]="0"
            class="flex-1">
          </ion-searchbar>
          <p-button-pure 
            [icon]="'plus'" 
            (click)="addStock()" 
            [hideLabel]="true"
            [theme]="'dark'">
            Add
          </p-button-pure>
        </div>
      </div>

      <!-- Search and View Toggle -->
      <div class="mb-4 flex gap-2">
        <ion-searchbar
          [(ngModel)]="searchTerm"
          placeholder="Search watchlist"
          [debounce]="300"
          class="flex-1">
        </ion-searchbar>
        <div class="flex gap-1">
          <p-button-pure 
            [icon]="'menu-lines'" 
            (click)="toggleViewMode()" 
            [hideLabel]="true"
            [theme]="'dark'"
            [active]="viewMode === 'card'">
            Card View
          </p-button-pure>
          <p-button-pure 
            [icon]="'list'" 
            (click)="toggleViewMode()" 
            [hideLabel]="true"
            [theme]="'dark'"
            [active]="viewMode === 'table'">
            Table View
          </p-button-pure>
        </div>
      </div>

      <!-- Loading State -->
      <div *ngIf="loadingStockDetails" class="text-center py-8">
        <p-text [size]="'medium'" [theme]="'dark'" class="text-[#C9C9CB]">
          Loading stock details...
        </p-text>
      </div>

      <!-- Card View -->
      <div *ngIf="viewMode === 'card' && !loadingStockDetails" class="stock-grid mb-4">
        <div 
          *ngFor="let stock of filteredWatchlist()" 
          class="stock-card bg-[#1E1E20] rounded-lg p-4 hover:bg-[#2A2A2C] transition-colors">
          <div class="flex items-start gap-3">
            <div class="stock-logo-container" (click)="openLogoUpload(stock)">
              <img 
                [src]="stock.logo || getDefaultLogo(stock.symbol)" 
                [alt]="stock.symbol"
                class="stock-logo"
                (error)="handleLogoError($event, stock)">
              <div class="logo-edit-overlay">
                <span class="edit-text">ðŸ“·</span>
              </div>
            </div>
            <div class="flex-1 min-w-0" (click)="removeStock(stock.symbol)" style="cursor: pointer;">
              <div class="flex items-start justify-between mb-1">
                <div>
                  <p-text [size]="'medium'" [theme]="'dark'" class="font-semibold block" style="padding: 0;">
                    {{ stock.symbol }}
                  </p-text>
                  <p-text [size]="'x-small'" [theme]="'dark'" class="text-[#86868B] block" style="padding: 0;">
                    {{ stock.name || 'Unknown Company' }}
                  </p-text>
                </div>
                <p-icon [name]="'close'" [size]="'x-small'" [theme]="'dark'" class="text-[#86868B]"></p-icon>
              </div>
              
              <div class="mt-3 space-y-1">
                <div class="flex justify-between items-center">
                  <p-text [size]="'x-small'" [theme]="'dark'" class="text-[#86868B]" style="padding: 0;">
                    Price
                  </p-text>
                  <p-text [size]="'small'" [theme]="'dark'" style="padding: 0;">
                    {{ formatPrice(stock.price) }}
                  </p-text>
                </div>
                
                <div class="flex justify-between items-center">
                  <p-text [size]="'x-small'" [theme]="'dark'" class="text-[#86868B]" style="padding: 0;">
                    Change
                  </p-text>
                  <p-text [size]="'x-small'" [theme]="'dark'" [class]="getChangeClass(stock.change)" style="padding: 0;">
                    {{ formatChange(stock.change, stock.changePercent) }}
                  </p-text>
                </div>
                
                <div class="flex justify-between items-center">
                  <p-text [size]="'x-small'" [theme]="'dark'" class="text-[#86868B]" style="padding: 0;">
                    Market Cap
                  </p-text>
                  <p-text [size]="'x-small'" [theme]="'dark'" style="padding: 0;">
                    {{ formatMarketCap(stock.marketCap) }}
                  </p-text>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div *ngIf="filteredWatchlist().length === 0" class="col-span-full text-center py-8">
          <p-text [size]="'medium'" [theme]="'dark'" class="text-[#C9C9CB]" style="padding: 4px 0;">
            {{ searchTerm ? 'No stocks found' : 'No stocks in watchlist. Add some symbols above!' }}
          </p-text>
        </div>
      </div>

      <!-- Table View -->
      <div *ngIf="viewMode === 'table' && !loadingStockDetails" class="stock-table-container mb-4">
        <table class="stock-table w-full">
          <thead>
            <tr class="border-b border-[#3A3A3C]">
              <th class="text-left py-3 px-2">
                <p-text [size]="'x-small'" [theme]="'dark'" class="text-[#86868B] font-semibold">Logo</p-text>
              </th>
              <th class="text-left py-3 px-2">
                <p-text [size]="'x-small'" [theme]="'dark'" class="text-[#86868B] font-semibold">Symbol</p-text>
              </th>
              <th class="text-left py-3 px-2">
                <p-text [size]="'x-small'" [theme]="'dark'" class="text-[#86868B] font-semibold">Name</p-text>
              </th>
              <th class="text-right py-3 px-2">
                <p-text [size]="'x-small'" [theme]="'dark'" class="text-[#86868B] font-semibold">Price</p-text>
              </th>
              <th class="text-right py-3 px-2">
                <p-text [size]="'x-small'" [theme]="'dark'" class="text-[#86868B] font-semibold">Change</p-text>
              </th>
              <th class="text-right py-3 px-2">
                <p-text [size]="'x-small'" [theme]="'dark'" class="text-[#86868B] font-semibold">Market Cap</p-text>
              </th>
              <th class="text-center py-3 px-2">
                <p-text [size]="'x-small'" [theme]="'dark'" class="text-[#86868B] font-semibold">Action</p-text>
              </th>
            </tr>
          </thead>
          <tbody>
            <tr 
              *ngFor="let stock of filteredWatchlist()" 
              class="border-b border-[#2A2A2C] hover:bg-[#2A2A2C] transition-colors">
              <td class="py-3 px-2">
                <div class="stock-logo-small-container" (click)="openLogoUpload(stock)">
                  <img 
                    [src]="stock.logo || getDefaultLogo(stock.symbol)" 
                    [alt]="stock.symbol"
                    class="stock-logo-small"
                    (error)="handleLogoError($event, stock)">
                  <div class="logo-edit-overlay-small">
                    <span class="edit-text-small">ðŸ“·</span>
                  </div>
                </div>
              </td>
              <td class="py-3 px-2">
                <p-text [size]="'small'" [theme]="'dark'" class="font-semibold">{{ stock.symbol }}</p-text>
              </td>
              <td class="py-3 px-2">
                <p-text [size]="'x-small'" [theme]="'dark'" class="text-[#C9C9CB]">{{ stock.name || 'Unknown' }}</p-text>
              </td>
              <td class="py-3 px-2 text-right">
                <p-text [size]="'small'" [theme]="'dark'">{{ formatPrice(stock.price) }}</p-text>
              </td>
              <td class="py-3 px-2 text-right">
                <p-text [size]="'x-small'" [theme]="'dark'" [class]="getChangeClass(stock.change)">
                  {{ formatChange(stock.change, stock.changePercent) }}
                </p-text>
              </td>
              <td class="py-3 px-2 text-right">
                <p-text [size]="'x-small'" [theme]="'dark'" class="text-[#C9C9CB]">{{ formatMarketCap(stock.marketCap) }}</p-text>
              </td>
              <td class="py-3 px-2 text-center">
                <p-button-pure 
                  [icon]="'close'" 
                  (click)="removeStock(stock.symbol)" 
                  [hideLabel]="true"
                  [size]="'small'"
                  [theme]="'dark'">
                  Remove
                </p-button-pure>
              </td>
            </tr>
            <tr *ngIf="filteredWatchlist().length === 0">
              <td colspan="7" class="text-center py-8">
                <p-text [size]="'medium'" [theme]="'dark'" class="text-[#C9C9CB]">
                  {{ searchTerm ? 'No stocks found' : 'No stocks in watchlist. Add some symbols above!' }}
                </p-text>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <p-button 
        expand="full" 
        [variant]="'secondary'"
        (click)="resetWatchlist()"
        [disabled]="watchlist.length === 0"
        [theme]="'dark'">
        Reset to Defaults
      </p-button>

      <p-text [size]="'x-small'" [theme]="'dark'" class="block mt-4 text-[#C9C9CB]" style="padding: 4px 0; line-height: 1.6;">
        {{ viewMode === 'card' ? 'Click on the card text to remove a stock. Click the logo to upload a custom image.' : 'Click the logo to upload a custom image. Use the Ã— button to remove stocks from your watchlist.' }}
      </p-text>
    </div>

    <!-- App Info -->
    <div class="bg-[#2C2C2E] rounded-lg p-8 shadow-lg">
      <p-heading [size]="'large'" [theme]="'dark'" class="mb-4" style="padding: 4px 0;">About</p-heading>
      <div class="space-y-2">
        <p-text [size]="'medium'" [theme]="'dark'" style="padding: 4px 0;"><strong>Earnings Calendar</strong></p-text>
        <p-text [size]="'small'" [theme]="'dark'" class="text-[#C9C9CB]" style="padding: 4px 0;">Version 1.0.0</p-text>
        <p-text [size]="'small'" [theme]="'dark'" class="text-[#C9C9CB]" style="padding: 4px 0;">Built with Ionic + Angular</p-text>
        <p-text [size]="'small'" [theme]="'dark'" class="text-[#C9C9CB]" style="padding: 4px 0;">Data from Financial Modeling Prep API</p-text>
        <p-text [size]="'small'" [theme]="'dark'" class="text-[#C9C9CB]" style="padding: 4px 0;">Design by Porsche Design System</p-text>
      </div>
    </div>

  </div>
</ion-content>

<!-- Hidden file input for logo upload -->
<input 
  type="file" 
  #logoFileInput 
  accept="image/*" 
  style="display: none;" 
  (change)="onLogoFileSelected($event)">
