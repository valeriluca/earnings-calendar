<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-title>
      <p-heading [size]="'large'" [theme]="'dark'">Earnings Calendar</p-heading>
    </ion-title>
    <ion-buttons slot="end">
      <p-button-pure [icon]="'reset'" (click)="loadEarnings()" [hideLabel]="true" [theme]="'dark'">
        Refresh
      </p-button-pure>
      <p-button-pure [icon]="'configurate'" (click)="navigateToSettings()" [hideLabel]="true" [theme]="'dark'">
        Settings
      </p-button-pure>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <ion-refresher slot="fixed" (ionRefresh)="handleRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <div class="p-6 max-w-7xl mx-auto">
    <!-- Loading State -->
    <div *ngIf="loading" class="flex flex-col items-center justify-center min-h-[400px] gap-6">
      <p-spinner [size]="'large'" [theme]="'dark'"></p-spinner>
      <p-text [size]="'medium'" [theme]="'dark'" class="text-[#86868d]">Loading earnings data...</p-text>
    </div>

    <!-- Error State -->
    <div *ngIf="error && !loading" class="flex flex-col items-center justify-center min-h-[400px] gap-6">
      <p-text [size]="'large'" [theme]="'dark'" class="text-[#d5001c]">{{ error }}</p-text>
      <p-button (click)="loadEarnings()" [variant]="'primary'" [theme]="'dark'">
        Retry
      </p-button>
    </div>

    <!-- Calendar View -->
    <div *ngIf="!loading && !error" class="space-y-6">
      <!-- Header Card -->
      <div class="bg-[#1a1a1d] rounded-lg p-6 shadow-lg">
        <p-heading [size]="'x-large'" [theme]="'dark'" class="mb-2">
          Upcoming Earnings
        </p-heading>
        <p-text [size]="'medium'" [theme]="'dark'" class="text-[#86868d]">
          Track earnings announcements for your watchlist stocks
        </p-text>
      </div>

      <!-- Calendar Container -->
      <div class="bg-[#1a1a1d] rounded-lg p-6 shadow-lg">
        <full-calendar [options]="calendarOptions"></full-calendar>
      </div>
      
      <!-- Legend Card -->
      <div class="bg-[#1a1a1d] rounded-lg p-6 shadow-lg">
        <p-heading [size]="'large'" [theme]="'dark'" class="mb-4">
          Legend
        </p-heading>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
          <div class="flex items-center gap-3">
            <div class="w-4 h-4 rounded" style="background-color: #3880ff;"></div>
            <p-text [size]="'small'" [theme]="'dark'">Before Market Open (BMO)</p-text>
          </div>
          <div class="flex items-center gap-3">
            <div class="w-4 h-4 rounded" style="background-color: #2dd36f;"></div>
            <p-text [size]="'small'" [theme]="'dark'">After Market Close (AMC)</p-text>
          </div>
          <div class="flex items-center gap-3">
            <div class="w-4 h-4 rounded" style="background-color: #ffc409;"></div>
            <p-text [size]="'small'" [theme]="'dark'">During Market Time (DMT)</p-text>
          </div>
          <div class="flex items-center gap-3">
            <div class="w-4 h-4 rounded" style="background-color: #92949c;"></div>
            <p-text [size]="'small'" [theme]="'dark'">Time TBD</p-text>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Earnings Detail Modal -->
  <ion-modal [isOpen]="isModalOpen" (didDismiss)="closeModal()">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>
            <p-heading [size]="'medium'" [theme]="'dark'">Earnings Details</p-heading>
          </ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="closeModal()">
              <p-icon [name]="'close'" [theme]="'dark'"></p-icon>
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      <ion-content class="ion-padding">
        <div *ngIf="selectedEvent" class="space-y-6">
          <!-- Company Info -->
          <div class="bg-[#1a1a1d] rounded-lg p-6 shadow-lg">
            <p-heading [size]="'large'" [theme]="'dark'" class="mb-2">
              {{ selectedEvent.title }}
            </p-heading>
            <p-text [size]="'medium'" [theme]="'dark'" class="text-[#86868d]">
              {{ selectedEvent.symbol }}
            </p-text>
          </div>

          <!-- Date & Time Info -->
          <div class="bg-[#1a1a1d] rounded-lg p-6 shadow-lg space-y-4">
            <div>
              <p-text [size]="'small'" [theme]="'dark'" class="block mb-1 text-[#86868d]">
                Date
              </p-text>
              <p-text [size]="'medium'" [theme]="'dark'">
                {{ formatModalDate(selectedEvent.date) }}
              </p-text>
            </div>

            <div>
              <p-text [size]="'small'" [theme]="'dark'" class="block mb-1 text-[#86868d]">
                Reporting Time
              </p-text>
              <p-text [size]="'medium'" [theme]="'dark'">
                {{ selectedEvent.timeLabel }}
              </p-text>
            </div>

            <div>
              <p-text [size]="'small'" [theme]="'dark'" class="block mb-1 text-[#86868d]">
                Berlin Time (Approximate)
              </p-text>
              <p-text [size]="'medium'" [theme]="'dark'" class="font-semibold">
                {{ selectedEvent.berlinTime }}
              </p-text>
            </div>
          </div>

          <!-- Financial Estimates -->
          <div *ngIf="selectedEvent.epsEstimated || selectedEvent.eps" class="bg-[#1a1a1d] rounded-lg p-6 shadow-lg space-y-4">
            <p-heading [size]="'medium'" [theme]="'dark'" class="mb-3">
              Financial Data
            </p-heading>

            <div *ngIf="selectedEvent.epsEstimated">
              <p-text [size]="'small'" [theme]="'dark'" class="block mb-1 text-[#86868d]">
                EPS Estimate
              </p-text>
              <p-text [size]="'medium'" [theme]="'dark'">
                ${{ selectedEvent.epsEstimated }}
              </p-text>
            </div>

            <div *ngIf="selectedEvent.eps">
              <p-text [size]="'small'" [theme]="'dark'" class="block mb-1 text-[#86868d]">
                Previous EPS
              </p-text>
              <p-text [size]="'medium'" [theme]="'dark'">
                ${{ selectedEvent.eps }}
              </p-text>
            </div>
          </div>

          <!-- Info Note -->
          <div class="bg-[#1a1a1d] rounded-lg p-4 shadow-lg">
            <p-text [size]="'x-small'" [theme]="'dark'" class="text-[#86868d]">
              <strong>Note:</strong> Berlin times are approximate and based on standard US market hours. 
              Actual earnings release times may vary. CET/CEST adjusts for daylight saving time.
            </p-text>
          </div>
        </div>
      </ion-content>
    </ng-template>
  </ion-modal>
</ion-content>
