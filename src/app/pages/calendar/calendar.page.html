<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-title style="padding-left: 16px;">
      <p-heading [size]="'large'" [theme]="'dark'">Earnings Calendar</p-heading>
    </ion-title>
    <ion-buttons slot="end">
      <p-button-pure [icon]="'reset'" (click)="loadEarnings()" [hideLabel]="true" [theme]="'dark'">
        Refresh
      </p-button-pure>
      <p-button-pure [icon]="'configurate'" (click)="navigateToSettings()" [hideLabel]="true" [theme]="'dark'">
        Settings
      </p-button-pure>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <ion-refresher slot="fixed" (ionRefresh)="handleRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <div class="p-6 max-w-7xl mx-auto">
    <!-- Loading State -->
    <div *ngIf="loading" class="flex flex-col items-center justify-center min-h-[400px] gap-6">
      <p-spinner [size]="'large'" [theme]="'dark'"></p-spinner>
      <p-text [size]="'medium'" [theme]="'dark'" class="text-[#86868d]">Loading earnings data...</p-text>
    </div>

    <!-- Error State -->
    <div *ngIf="error && !loading" class="flex flex-col items-center justify-center min-h-[400px] gap-6">
      <p-text [size]="'large'" [theme]="'dark'" class="text-[#d5001c]">{{ error }}</p-text>
      <p-button (click)="loadEarnings()" [variant]="'primary'" [theme]="'dark'">
        Retry
      </p-button>
    </div>

    <!-- Calendar View -->
    <div *ngIf="!loading && !error" class="space-y-6">
      <!-- Header Card -->
      <div class="bg-transparent rounded-lg p-6 shadow-lg calendar-card-blur">
        <p-heading [size]="'x-large'" [theme]="'dark'" class="mb-2">
          Upcoming Earnings
        </p-heading>
        <p-text [size]="'medium'" [theme]="'dark'" class="text-[#C9C9CB]">
          Track earnings announcements for your watchlist stocks
        </p-text>
      </div>

      <!-- Calendar Container -->
      <div class="bg-transparent rounded-lg p-6 shadow-lg calendar-card-blur">
        <full-calendar #calendar [options]="calendarOptions"></full-calendar>
      </div>
      
      <!-- Legend Card -->
      <div class="bg-transparent rounded-lg p-6 shadow-lg calendar-card-blur">
        <p-heading [size]="'large'" [theme]="'dark'" class="mb-4">
          Legend
        </p-heading>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
          <div class="flex items-center gap-3">
            <div class="w-4 h-4 rounded" style="background-color: #A31E39;"></div>
            <p-text [size]="'small'" [theme]="'dark'">Before Market Open (BMO)</p-text>
          </div>
          <div class="flex items-center gap-3">
            <div class="w-4 h-4 rounded" style="background-color: #6B7280;"></div>
            <p-text [size]="'small'" [theme]="'dark'">After Market Close (AMC)</p-text>
          </div>
          <div class="flex items-center gap-3">
            <div class="w-4 h-4 rounded" style="background-color: #D94A6A;"></div>
            <p-text [size]="'small'" [theme]="'dark'">During Market Time (DMT)</p-text>
          </div>
          <div class="flex items-center gap-3">
            <div class="w-4 h-4 rounded" style="background-color: #4B5563;"></div>
            <p-text [size]="'small'" [theme]="'dark'">Time TBD</p-text>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Earnings Detail Modal -->
  <ion-modal [isOpen]="isModalOpen" (didDismiss)="closeModal()">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>
            <p-heading [size]="'medium'" [theme]="'dark'">Earnings Details</p-heading>
          </ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="closeModal()">
              <p-icon [name]="'close'" [theme]="'dark'"></p-icon>
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      <ion-content class="ion-padding">
        <div *ngIf="selectedEvent" class="space-y-6">
          <!-- Company Info -->
          <div class="bg-transparent rounded-lg p-8 shadow-lg modal-card-blur">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
              <img 
                *ngIf="selectedEvent.logoUrl"
                [src]="selectedEvent.logoUrl" 
                [alt]="selectedEvent.title"
                style="width: 48px; height: 48px; border-radius: 8px; object-fit: contain; background: white; padding: 4px;"
                (error)="$event.target.style.display='none'"
              />
              <div>
                <p-heading [size]="'large'" [theme]="'dark'" class="mb-2" style="padding: 4px 0;">
                  {{ selectedEvent.title }}
                </p-heading>
                <p-text [size]="'medium'" [theme]="'dark'" class="text-[#C9C9CB]" style="padding: 4px 0;">
                  {{ selectedEvent.symbol }}
                </p-text>
              </div>
            </div>
          </div>

          <!-- Date & Time Info -->
          <div class="bg-transparent rounded-lg p-8 shadow-lg space-y-4 modal-card-blur">
            <div style="margin-bottom: 16px;">
              <p-text [size]="'small'" [theme]="'dark'" class="block mb-1 text-[#C9C9CB]" style="padding: 4px 0;">
                Date
              </p-text>
              <p-text [size]="'medium'" [theme]="'dark'" style="padding: 4px 0;">
                {{ formatModalDate(selectedEvent.date) }}
              </p-text>
            </div>

            <div style="margin-bottom: 16px;">
              <p-text [size]="'small'" [theme]="'dark'" class="block mb-1 text-[#C9C9CB]" style="padding: 4px 0;">
                Reporting Time
              </p-text>
              <p-text [size]="'medium'" [theme]="'dark'" style="padding: 4px 0;">
                {{ selectedEvent.timeLabel }}
              </p-text>
            </div>

            <div>
              <p-text [size]="'small'" [theme]="'dark'" class="block mb-1 text-[#C9C9CB]" style="padding: 4px 0;">
                Berlin Time (Approximate)
              </p-text>
              <p-text [size]="'medium'" [theme]="'dark'" class="font-semibold" style="padding: 4px 0;">
                {{ selectedEvent.berlinTime }}
              </p-text>
            </div>
          </div>

          <!-- Financial Estimates -->
          <div *ngIf="selectedEvent.epsEstimated || selectedEvent.eps" class="bg-transparent rounded-lg p-8 shadow-lg space-y-4 modal-card-blur">
            <p-heading [size]="'medium'" [theme]="'dark'" class="mb-3" style="padding: 4px 0;">
              Financial Data
            </p-heading>

            <div *ngIf="selectedEvent.epsEstimated" style="margin-bottom: 16px;">
              <p-text [size]="'small'" [theme]="'dark'" class="block mb-1 text-[#C9C9CB]" style="padding: 4px 0;">
                EPS Estimate
              </p-text>
              <p-text [size]="'medium'" [theme]="'dark'" style="padding: 4px 0;">
                ${{ selectedEvent.epsEstimated }}
              </p-text>
            </div>

            <div *ngIf="selectedEvent.eps">
              <p-text [size]="'small'" [theme]="'dark'" class="block mb-1 text-[#C9C9CB]" style="padding: 4px 0;">
                Previous EPS
              </p-text>
              <p-text [size]="'medium'" [theme]="'dark'" style="padding: 4px 0;">
                ${{ selectedEvent.eps }}
              </p-text>
            </div>
          </div>

          <!-- Info Note -->
          <div class="bg-transparent rounded-lg p-6 shadow-lg modal-card-blur">
            <p-text [size]="'x-small'" [theme]="'dark'" class="text-[#C9C9CB]" style="padding: 4px 0; line-height: 1.6;">
              <strong>Note:</strong> Berlin times are approximate and based on standard US market hours. 
              Actual earnings release times may vary. CET/CEST adjusts for daylight saving time.
            </p-text>
          </div>
        </div>
      </ion-content>
    </ng-template>
  </ion-modal>
</ion-content>
