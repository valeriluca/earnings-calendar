<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-title style="padding-left: 16px;">
      <p-heading [size]="'large'" [theme]="'dark'">Earnings Calendar</p-heading>
    </ion-title>
    <ion-buttons slot="end">
      <p-button-pure [icon]="'reset'" (click)="loadEarnings()" [hideLabel]="true" [theme]="'dark'">
        Refresh
      </p-button-pure>
      <p-button-pure [icon]="'configurate'" (click)="navigateToSettings()" [hideLabel]="true" [theme]="'dark'">
        Settings
      </p-button-pure>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <ion-refresher slot="fixed" (ionRefresh)="handleRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <div class="p-6 max-w-7xl mx-auto">
    <!-- Loading State -->
    <div *ngIf="loading" class="flex flex-col items-center justify-center min-h-[400px] gap-6">
      <p-spinner [size]="'large'" [theme]="'dark'"></p-spinner>
      <p-text [size]="'medium'" [theme]="'dark'" class="text-[#86868d]">Loading earnings data...</p-text>
    </div>

    <!-- Error State -->
    <div *ngIf="error && !loading" class="flex flex-col items-center justify-center min-h-[400px] gap-6">
      <p-text [size]="'large'" [theme]="'dark'" class="text-[#d5001c]">{{ error }}</p-text>
      <p-button (click)="loadEarnings()" [variant]="'primary'" [theme]="'dark'">
        Retry
      </p-button>
    </div>

    <!-- Calendar View -->
    <div *ngIf="!loading && !error" class="space-y-6">
      <!-- Header Card -->
      <div class="bg-transparent rounded-lg p-6 shadow-lg calendar-card-blur">
        <p-heading [size]="'x-large'" [theme]="'dark'" class="mb-2">
          Upcoming Earnings
        </p-heading>
        <p-text [size]="'medium'" [theme]="'dark'" class="text-[#C9C9CB]">
          Track earnings announcements for your watchlist stocks
        </p-text>
      </div>

      <!-- Calendar Container -->
      <div class="bg-transparent rounded-lg p-6 shadow-lg calendar-card-blur">
        <full-calendar #calendar [options]="calendarOptions"></full-calendar>
      </div>
      
      <!-- Legend Card -->
      <div class="bg-transparent rounded-lg p-6 shadow-lg calendar-card-blur">
        <p-heading [size]="'large'" [theme]="'dark'" class="mb-4">
          Legend
        </p-heading>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
          <div class="flex items-center gap-3">
            <div class="w-4 h-4 rounded" style="background-color: #A31E39;"></div>
            <p-text [size]="'small'" [theme]="'dark'">Before Market Open (BMO)</p-text>
          </div>
          <div class="flex items-center gap-3">
            <div class="w-4 h-4 rounded" style="background-color: #6B7280;"></div>
            <p-text [size]="'small'" [theme]="'dark'">After Market Close (AMC)</p-text>
          </div>
          <div class="flex items-center gap-3">
            <div class="w-4 h-4 rounded" style="background-color: #D94A6A;"></div>
            <p-text [size]="'small'" [theme]="'dark'">During Market Time (DMT)</p-text>
          </div>
          <div class="flex items-center gap-3">
            <div class="w-4 h-4 rounded" style="background-color: #4B5563;"></div>
            <p-text [size]="'small'" [theme]="'dark'">Time TBD</p-text>
          </div>
          <div class="flex items-center gap-3">
            <div class="w-4 h-4 rounded" style="background-color: #1E3A5F; border: 1px solid #2563EB;"></div>
            <p-text [size]="'small'" [theme]="'dark'">üèõÔ∏è Market Holiday</p-text>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Event Detail Modal -->
  <ion-modal [isOpen]="isModalOpen" (didDismiss)="closeModal()">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>
            <p-heading [size]="'medium'" [theme]="'dark'">
              {{ selectedEvent?.type === 'holiday' ? 'Market Holiday' : 'Earnings Details' }}
            </p-heading>
          </ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="closeModal()">
              <p-icon [name]="'close'" [theme]="'dark'"></p-icon>
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      <ion-content class="ion-padding">
        <!-- Earnings Event Modal Content -->
        <div *ngIf="selectedEvent && selectedEvent.type !== 'holiday'" class="space-y-6">
          <!-- Company Info -->
          <div class="bg-transparent rounded-lg p-8 shadow-lg modal-card-blur">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
              <img 
                *ngIf="selectedEvent.logoUrl"
                [src]="selectedEvent.logoUrl" 
                [alt]="selectedEvent.title"
                style="width: 48px; height: 48px; border-radius: 8px; object-fit: contain; background: white; padding: 4px;"
                (error)="$event.target.style.display='none'"
              />
              <div>
                <p-heading [size]="'large'" [theme]="'dark'" class="mb-2" style="padding: 4px 0;">
                  {{ selectedEvent.title }}
                </p-heading>
                <p-text [size]="'medium'" [theme]="'dark'" class="text-[#C9C9CB]" style="padding: 4px 0;">
                  {{ selectedEvent.symbol }}
                </p-text>
              </div>
            </div>
          </div>

          <!-- Date & Time Info -->
          <div class="bg-transparent rounded-lg p-8 shadow-lg space-y-4 modal-card-blur">
            <div style="margin-bottom: 16px;">
              <p-text [size]="'small'" [theme]="'dark'" class="block mb-1 text-[#C9C9CB]" style="padding: 4px 0;">
                Date
              </p-text>
              <p-text [size]="'medium'" [theme]="'dark'" style="padding: 4px 0;">
                {{ formatModalDate(selectedEvent.date) }}
              </p-text>
            </div>

            <div style="margin-bottom: 16px;">
              <p-text [size]="'small'" [theme]="'dark'" class="block mb-1 text-[#C9C9CB]" style="padding: 4px 0;">
                Earnings Call Time
              </p-text>
              <div style="display: flex; align-items: center; gap: 8px; padding: 4px 0;">
                <p-text [size]="'medium'" [theme]="'dark'">
                  {{ selectedEvent.timeLabel }}
                </p-text>
                <span *ngIf="selectedEvent.exactTime" style="background: rgba(139, 21, 56, 0.3); padding: 4px 10px; border-radius: 999px; font-size: 13px; color: #fff; font-weight: 500;">
                  üïê {{ selectedEvent.exactTime }} ET
                </span>
              </div>
            </div>

            <div style="margin-bottom: 16px;">
              <p-text [size]="'small'" [theme]="'dark'" class="block mb-1 text-[#C9C9CB]" style="padding: 4px 0;">
                Berlin Time
              </p-text>
              <p-text [size]="'medium'" [theme]="'dark'" class="font-semibold" style="padding: 4px 0;">
                <span *ngIf="selectedEvent.exactBerlinTime" style="background: rgba(37, 99, 235, 0.3); padding: 4px 10px; border-radius: 999px; font-size: 13px; font-weight: 500;">
                  üá©üá™ {{ selectedEvent.exactBerlinTime }}
                </span>
                <span *ngIf="!selectedEvent.exactBerlinTime">
                  {{ selectedEvent.berlinTime }}
                </span>
              </p-text>
            </div>

            <div *ngIf="!selectedEvent.exactTime">
              <p-text [size]="'x-small'" [theme]="'dark'" class="text-[#C9C9CB]" style="padding: 4px 0; font-style: italic;">
                Exact time not yet announced
              </p-text>
            </div>
          </div>

          <!-- Financial Estimates -->
          <div *ngIf="selectedEvent.epsEstimated || selectedEvent.eps" class="bg-transparent rounded-lg p-8 shadow-lg space-y-4 modal-card-blur">
            <p-heading [size]="'medium'" [theme]="'dark'" class="mb-3" style="padding: 4px 0;">
              Financial Data
            </p-heading>

            <div *ngIf="selectedEvent.epsEstimated" style="margin-bottom: 16px;">
              <p-text [size]="'small'" [theme]="'dark'" class="block mb-1 text-[#C9C9CB]" style="padding: 4px 0;">
                EPS Estimate
              </p-text>
              <p-text [size]="'medium'" [theme]="'dark'" style="padding: 4px 0;">
                ${{ selectedEvent.epsEstimated }}
              </p-text>
            </div>

            <div *ngIf="selectedEvent.eps">
              <p-text [size]="'small'" [theme]="'dark'" class="block mb-1 text-[#C9C9CB]" style="padding: 4px 0;">
                Previous EPS
              </p-text>
              <p-text [size]="'medium'" [theme]="'dark'" style="padding: 4px 0;">
                ${{ selectedEvent.eps }}
              </p-text>
            </div>
          </div>

          <!-- Info Note -->
          <div class="bg-transparent rounded-lg p-6 shadow-lg modal-card-blur">
            <p-text [size]="'x-small'" [theme]="'dark'" class="text-[#C9C9CB]" style="padding: 4px 0; line-height: 1.6;">
              <strong>Note:</strong> Times shown in ET (Eastern Time) are converted to Berlin time (CET/CEST). 
              When exact call times are available, they are displayed with üïê. Otherwise, approximate times are shown based on BMO/AMC/DMT classification.
            </p-text>
          </div>
        </div>

        <!-- Holiday Event Modal Content -->
        <div *ngIf="selectedEvent && selectedEvent.type === 'holiday'" class="space-y-6">
          <!-- Holiday Info -->
          <div class="bg-transparent rounded-lg p-8 shadow-lg modal-card-blur">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
              <div style="font-size: 48px;">üèõÔ∏è</div>
              <div>
                <p-heading [size]="'large'" [theme]="'dark'" class="mb-2" style="padding: 4px 0;">
                  {{ selectedEvent.title }}
                </p-heading>
                <p-text [size]="'medium'" [theme]="'dark'" class="text-[#C9C9CB]" style="padding: 4px 0;">
                  Market Holiday
                </p-text>
              </div>
            </div>
          </div>

          <!-- Date Info -->
          <div class="bg-transparent rounded-lg p-8 shadow-lg modal-card-blur">
            <p-text [size]="'small'" [theme]="'dark'" class="block mb-1 text-[#C9C9CB]" style="padding: 4px 0;">
              Date
            </p-text>
            <p-text [size]="'medium'" [theme]="'dark'" style="padding: 4px 0;">
              {{ formatModalDate(selectedEvent.date) }}
            </p-text>
          </div>

          <!-- Closed Markets -->
          <div class="bg-transparent rounded-lg p-8 shadow-lg modal-card-blur">
            <p-heading [size]="'medium'" [theme]="'dark'" class="mb-4" style="padding: 4px 0;">
              Closed Markets
            </p-heading>
            <div class="market-list">
              <div *ngFor="let market of selectedEvent.markets" class="market-item" style="display: flex; align-items: center; gap: 12px; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                <span style="font-size: 24px;">{{ getMarketInfo(market).flag }}</span>
                <div>
                  <p-text [size]="'medium'" [theme]="'dark'" style="display: block;">
                    {{ market }}
                  </p-text>
                  <p-text [size]="'small'" [theme]="'dark'" class="text-[#C9C9CB]">
                    {{ getMarketInfo(market).name }} ({{ getMarketInfo(market).country }})
                  </p-text>
                </div>
              </div>
            </div>
          </div>

          <!-- Info Note -->
          <div class="bg-transparent rounded-lg p-6 shadow-lg modal-card-blur">
            <p-text [size]="'x-small'" [theme]="'dark'" class="text-[#C9C9CB]" style="padding: 4px 0; line-height: 1.6;">
              <strong>Note:</strong> Markets listed above will be closed for trading on this date. 
              Trading may still be possible on other exchanges. Always verify with your broker.
            </p-text>
          </div>
        </div>
      </ion-content>
    </ng-template>
  </ion-modal>
</ion-content>
